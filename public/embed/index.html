<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
        <script
        src="https://ccpublicbucket.s3-ap-southeast-2.amazonaws.com/soundtrails_plugin/soundtrailWebViewer/leaflet/leaflet-src.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
    <script src="../../SoundtrailParserUpdated.js"></script>
</head>

<body>
    <div id="Map Container" style="position: relative;">
        <div id="map"></div>
    </div>

    

    <style>

        .leaflet-popup-content img {
            max-width: 100%;
            min-width: 100%;
            max-height: 40vh;
            object-fit: contain;
            background: #f2f4f4;
            /* margin-bottom: 30px; */
        }

        .leaflet-popup-content {
            margin: 0 !important;
            width: 100% !important;
            height: 100%;
        }

        .leaflet-popup-pane {
            margin: 0;
            z-index: 9999;
            transform: initial !important;
            position: absolute;
            top: 0px !important;
            left: 0px !important;
            width: 0;
            height: 100%;
            bottom: 0 !important;
            display: flex;
            box-sizing: border-box;
        }

        .leaflet-popup-content-wrapper {
            width: 100%;
            height: 100%;
            /* opacity: .95; */
            padding: 0;
            /* visibility: hidden; */
            touch-action: none;
            overflow: none;
            box-sizing: border-box;
            border-radius: 0;
            box-shadow: none;
            display: flex;
        }

        a.leaflet-popup-close-button {
            position: absolute;
            z-index: 9999;
            top: 25px;
            right: 25px;
            width: 36px;
            height: 36px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            background: url("https://ccpublicbucket.s3-ap-southeast-2.amazonaws.com/soundtrails_plugin/soundtrailWebViewer/close.png");
            background-size: contain;
            text-indent: -9999px;
        }

        .leaflet-popup-content-wrapper p {
            margin: 0 30px 1em 30px;
            font-size: 1.3em;
        }

        .leaflet-popup {
            left: 0px !important;
            right: 0px !important;
            top: 0px !important;
            bottom: 0px !important;
        }

        .leaflet-popup-content>div {
            max-width: 100%;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            border-radius: 10px;
            background-color: #ffffff88;
        }

        ::-webkit-scrollbar-thumb {
            background: #aaaaaa;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #888888;
        }

        audio::-webkit-media-controls-mute-button {
            display: none !important;
        }

        audio::-webkit-media-controls-volume-slider {
            display: none !important;
        }

        #map {
            height: 580px;
            width: 580px;
        } 

        .imgSlider {
            align-items: center;
        }

        .leaflet-popup-content-wrapper h3 {
            padding: 0 76px 0 20px;
            font-size: 1.8em;
            line-height: 1em;
        }

        .leaflet-popup-content-wrapper h4 {
            margin-top: -10px;
        }

        .leaflet-popup,
        .leaflet-popup-tip {
            overflow-y: hidden !important;
            height: 580px;
            width: 580px;
        }

        .leaflet-popup-content-wrapper {
            height: 580px;
            overflow: hidden;
        }

        .leaflet-popup {
            overflow-y: scroll;
            overflow-x: hidden;
        }

        button.slick-next,
        button.slick-next:hover {
            position: absolute;
            top: calc(50% - 24px);
            right: 225px;
            width: 48px;
            height: 48px;
            background-image: url("https://ccpublicbucket.s3-ap-southeast-2.amazonaws.com/soundtrails_plugin/soundtrailWebViewer/right-arrow.png");
            background-size: contain;
        }

        button[class*="slick"] {
            border: none;
            background-color: transparent;
            text-indent: -9999px;
            outline: none;
            cursor: pointer;
        }

        button.slick-prev,
        button.slick-prev:hover {
            position: absolute;
            top: calc(50% - 24px);
            left: 25px;
            z-index: 1;
            width: 48px;
            height: 48px;
            background-image: url("https://ccpublicbucket.s3-ap-southeast-2.amazonaws.com/soundtrails_plugin/soundtrailWebViewer/left-arrow.png");
            background-size: contain;
        }
    </style>



    <script>

        function setUpTheSliderForThePopup(e) {
            console.log('setting up the slider', e);
            $('.slider').slick({
                dots: false,
                infinite: true,
                touchMove: true,
                speed: 500,
                slidesToShow: 1,
                slidesToScroll: 1,
                autoplay: false,
                autoplaySpeed: 2000,
                arrows: true,
                centerMode: true,
                responsive: [{
                    breakpoint: 600,
                    settings: {
                        slidesToShow: 1,
                        slidesToScroll: 1
                    }
                },
                {
                    breakpoint: 580,
                    settings: {
                        arrows: false,
                        slidesToShow: 1,
                        slidesToScroll: 1
                    }
                }]
            });
        }

        const map = L.map('map', {showPopupOverMap: true, }).setView([-26.6237, 152.9588], 20);
        map.setMaxZoom(24)
        map.setMinZoom(16)
        const showMap = true // if you want to display the OSM layer
        if (showMap) {
            const osm = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
            map.addLayer(osm);
        }

        const getUrlParameter = function getUrlParameter(sParam) {
            var sPageURL = window.location.search.substring(1),
                sURLVariables = sPageURL.split('&'),
                sParameterName,
                i;

            for (i = 0; i < sURLVariables.length; i++) {
                sParameterName = sURLVariables[i].split('=');

                if (sParameterName[0] === sParam) {
                    return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
                }
            }
            return null;
        };

        var soundtrail = getUrlParameter("stUrl");

        if (soundtrail === null) soundtrail = "../samples/withIdTest.stx";

        // this'll take care of the rest
        fetch(soundtrail)
            .then(res => res.text())
            .then(kmltext => {
                // Create new kml overlay
                const parser = new DOMParser();
                const kml = parser.parseFromString(kmltext, 'text/xml');
                const track = new L.KML(kml);

                map.addLayer(track);
                // Adjust map to show the kml
                var bounds = track.getBounds();

                map.fitBounds(bounds); // zoom and centre map to fit the known hotspots

                var kmlHas_mapImageBounds, kmlDataDocumentProperties, kmlDdpArray, mapImageBounds;

                // See if we have the mapImageBounds property in this stx file
                try {
                    kmlDataDocumentProperties = kml.getElementsByTagName("Document")[0].getElementsByTagName("ExtendedData")[0].getElementsByTagName("Data");
                    kmlDdpArray = [...kmlDataDocumentProperties];
                    mapImageBounds = kmlDdpArray.filter((e) => e.attributes.getNamedItem('name').value == "mapImageBounds");
                    kmlHas_mapImageBounds = (mapImageBounds.length > 0);
                } catch (e) {
                    var errMsg = 'Exception trying to parse document for <Document><ExtendedData><Data> \n' +
                        e.toString();
                    console.warn(errMsg);
                    kmlHas_mapImageBounds = false;
                }

                // If we have it then attempt to parse it and use it
                if (kmlHas_mapImageBounds) {
                    try {
                        var bPoints = mapImageBounds[0].children[0].innerHTML.trim().split(" ");
                        var bp1 = bPoints[0].split(',');
                        var bp2 = bPoints[1].split(',');

                        var corner1 = L.latLng(parseFloat(bp1[1]), parseFloat(bp1[0])),
                            corner2 = L.latLng(parseFloat(bp2[1]), parseFloat(bp2[0])),
                            bounds = L.latLngBounds(corner1, corner2);

                    } catch (e) {
                        var errMsg = 'Unable to parse the "mapImageBounds" ExtendedData Data value, should look something like "-26.623856,152.957048 -26.62881,152.963322" \n' +
                            e.toString();
                        console.error(errMsg);
                        alert(errMsg);
                        kmlHas_mapImageBounds = false;
                    }
                }

                if (!kmlHas_mapImageBounds) {
                    console.warn('No mapImageBounds property, using the hotspots to set bounds');
                    // Set them to an area just larger than the known map size
                    bounds._southWest.lat -= 0.002;
                    bounds._southWest.lng -= 0.002;
                    bounds._northEast.lat += 0.002;
                    bounds._northEast.lng += 0.002;
                }

                map.setMaxBounds(bounds);


                map.on('drag', function () {
                    map.panInsideBounds(bounds, { animate: false });
                });

                map.setZoom(16);

            });


        jQuery(document).ready(function ($) {

            map.on('popupopen', function (e) {

                setUpTheSliderForThePopup(e);

            });
        });


    </script>
</body>

</html>